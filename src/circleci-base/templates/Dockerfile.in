FROM ${IMAGE_FROM}

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

LABEL maintainer="${MAINTAINER}" \
      description="${APPLICATION_NAME}: \
${APPLICATION_DESCRIPTION}"

USER root

ENV CIRCLECI_USER="${CIRCLECI_USER}" \
    PATH="/home/${CIRCLECI_USER}/scripts:/home/${CIRCLECI_USER}/google-cloud-sdk/bin:${PATH}"

WORKDIR /home/${CIRCLECI_USER}

COPY .curlrc /home/${CIRCLECI_USER}

COPY ./scripts /home/${CIRCLECI_USER}/scripts

RUN git clone https://github.com/sstephenson/bats.git && \
    ./bats/install.sh /usr/local && \
    rm -fr /home/${CIRCLECI_USER}/bats && \
    curl -sS "https://shellcheck.storage.googleapis.com/shellcheck-v${SHELLCHECK_VERSION}.linux.x86_64.tar.xz" -o /tmp/shellcheck.tar.xz && \
    tar xf /tmp/shellcheck.tar.xz -C /tmp/ && \
    mv /tmp/shellcheck-v${SHELLCHECK_VERSION}/shellcheck /usr/local/bin && \
    curl -sS "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip" > /tmp/terraform.zip && \
    unzip /tmp/terraform.zip -d /usr/local/bin && \
    chmod 0755 /usr/local/bin/terraform && \
    curl -sSO "https://github.com/gruntwork-io/terragrunt/releases/download/v${TERRAGRUNT_VERSION}/terragrunt_linux_amd64" && \
    chmod 0755 terragrunt_linux_amd64 && \
    mv terragrunt_linux_amd64 /usr/local/bin/terragrunt && \
    chmod 0755 /home/${CIRCLECI_USER}/scripts/* && \
    export "DESIRED_VERSION=v${HELM_VERSION}" && \
    curl -sS https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get | bash - && \
    curl -sS https://raw.githubusercontent.com/petervanderdoes/gitflow-avh/develop/contrib/gitflow-installer.sh | bash -s install version ${GIT_FLOW_VERSION} && \
    rm -fr git-flow && \
    curl -s https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 > /usr/local/bin/cloud_sql_proxy && \
    chmod 0755 /usr/local/bin/cloud_sql_proxy && \
    apt-get install -y --no-install-recommends \
      gawk \
      gettext \
      mysql-client \
      python-pip \
      python-pkg-resources \
      python-setuptools \
      silversearcher-ag \
      vim \
      wget \
      && \
    pip install yamllint && \
    npm install -g \
      junit-merge \
      tap-xunit && \
    rm -rf /tmp/* && \
    rm -rf /var/tmp/* && \
    rm -rf /var/lib/apt/lists/*

USER ${CIRCLECI_USER}

RUN curl "https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-${GOOGLE_SDK_VERSION}-linux-x86_64.tar.gz" | tar xz && \
    CLOUDSDK_CORE_DISABLE_PROMPTS=1 ./google-cloud-sdk/install.sh \
        --usage-reporting false \
        --bash-completion false \
        --path-update false \
        --rc-path "/home/${CIRCLECI_USER}/.bashrc" && \
    gcloud --quiet components update kubectl
